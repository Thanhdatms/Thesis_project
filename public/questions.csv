question,sql
What are all the products available in the store?,"SELECT 
    product_id,
    product_name,
    product_description,
    product_price,
    product_created_at,
    product_updated_at
FROM 
    products;"
Which products cost more than 100 dollars?,"SELECT 
    product_id,
    product_name,
    product_description,
    product_price,
    product_created_at,
    product_updated_at
FROM products
WHERE product_price > 100;"
Which items were newly listed in the store over the past 30 days?,"SELECT 
    product_id,
    product_name,
    product_description,
    product_price,
    product_created_at
FROM products
WHERE product_created_at >= NOW() - INTERVAL '30 days'
ORDER BY product_created_at DESC;"
What is the average price of all products?,"SELECT 
    product_id,
    product_name,
    ROUND(AVG(product_price), 2) AS average_price
FROM products;"
How many items does each category include?,"SELECT 
    c.category_name,
    COUNT(p.product_id) AS product_count
FROM 
    categories c
LEFT JOIN category_products cp 
    ON c.category_id = cp.category_product_category_id
LEFT JOIN products p 
    ON p.product_id = cp.category_product_product_id
GROUP BY 
    c.category_name;"
Show me the category that has the most items.,"SELECT 
    c.category_name,
    COUNT(p.product_id) AS product_count
FROM 
    categories c
LEFT JOIN category_products cp 
    ON c.category_id = cp.category_product_category_id
LEFT JOIN products p 
    ON p.product_id = cp.category_product_product_id
GROUP BY 
    c.category_name
ORDER BY 
	product_count DESC
LIMIT 1;"
Can you list all products along with their categories?,"SELECT 
    p.product_id,
    p.product_name,
	c.category_name
FROM 
    categories c
LEFT JOIN category_products cp 
    ON c.category_id = cp.category_product_category_id
LEFT JOIN products p 
    ON p.product_id = cp.category_product_product_id
GROUP BY 
    p.product_name, c.category_name;"
What are the top 5 most expensive products?,"SELECT 
    product_id,
    product_name,
    product_description,
    product_price
FROM products
ORDER BY product_price DESC
LIMIT 5;"
Which products are currently discounted?,"SELECT 
    p.product_id,
    p.product_name,
    p.product_price,
    d.discount_name,
    d.discount_percentage,
    d.discount_start_date,
    d.discount_end_date
FROM 
    products p
JOIN product_discounts pd 
    ON p.product_id = pd.product_discount_product_id
JOIN discounts d 
    ON d.discount_id = pd.product_discount_discount_id
WHERE 
    NOW() BETWEEN d.discount_start_date AND d.discount_end_date
ORDER BY 
    d.discount_percentage DESC;"
Show me all products sold by each vendor.,"SELECT
    v.vendor_name,
    p.product_name,
    p.product_price,
    p.product_description
FROM 
    vendors v
JOIN product_vendors pv 
    ON v.vendor_id = pv.product_vendor_vendor_id
JOIN products p 
    ON p.product_id = pv.product_vendor_product_id
ORDER BY 
    v.vendor_name, p.product_name;
"
What tags are used most often across products?,"SELECT 
    t.tag_name,
    COUNT(pt.product_tag_product_id) AS usage_count
FROM 
    tags t
JOIN product_tags pt 
    ON t.tag_id = pt.product_tag_tag_id
GROUP BY 
    t.tag_name
ORDER BY 
    usage_count DESC;"
List the products marked as new arrivals.,"SELECT 
    p.product_id,
    p.product_name,
    p.product_description,
    p.product_price,
    p.product_created_at
FROM 
    products p
JOIN product_tags pt 
    ON p.product_id = pt.product_tag_product_id
JOIN tags t 
    ON t.tag_id = pt.product_tag_tag_id
WHERE 
    LOWER(t.tag_name) = 'new'
ORDER BY 
    p.product_created_at DESC;"
How many items are in each user’s cart?,"SELECT 
    u.user_id,
    u.user_name,
    COUNT(ci.cart_item_id) AS item_count
FROM 
    users u
JOIN cart c 
    ON u.user_id = c.cart_user_id
LEFT JOIN cart_items ci 
    ON c.cart_id = ci.cart_item_cart_id
GROUP BY 
    u.user_id, u.user_name
ORDER BY 
    item_count DESC;"
What is the total value of each user’s cart?,"SELECT 
    u.user_id,
    u.user_name,
    COALESCE(SUM(ci.cart_item_quantity * ci.cart_item_price), 0) AS total_cart_value
FROM 
    users u
JOIN cart c 
    ON u.user_id = c.cart_user_id
LEFT JOIN cart_items ci 
    ON c.cart_id = ci.cart_item_cart_id
GROUP BY 
    u.user_id, u.user_name
ORDER BY 
    total_cart_value DESC;"
Show me users who haven’t added anything to their cart.,"SELECT 
    u.user_id,
    u.user_name
FROM 
    users u
JOIN cart c 
    ON u.user_id = c.cart_user_id
LEFT JOIN cart_items ci 
    ON c.cart_id = ci.cart_item_cart_id
WHERE 
    ci.cart_item_id IS NULL;"
Which products appear most often in wishlists?,"SELECT 
    p.product_id,
    p.product_name,
    COUNT(wi.wishlist_item_id) AS wishlist_count
FROM 
    products p
JOIN wishlist_items wi 
    ON p.product_id = wi.wishlist_item_product_id
JOIN wishlist w 
    ON w.wishlist_id = wi.wishlist_item_wishlist_id
GROUP BY 
    p.product_id, p.product_name
ORDER BY 
    wishlist_count DESC;"
Can you tell me which users made a wishlist in the past week?,"SELECT 
    u.user_id,
    u.user_name,
    w.wishlist_created_at
FROM 
    users u
JOIN wishlist w 
    ON u.user_id = w.wishlist_user_id
WHERE 
    w.wishlist_created_at >= NOW() - INTERVAL '7 days'
ORDER BY 
    w.wishlist_created_at DESC;"
What is the average number of items per wishlist?,"SELECT 
    ROUND(AVG(item_count), 2) AS average_items_per_wishlist
FROM (
    SELECT 
        w.wishlist_id,
        COUNT(wi.wishlist_item_id) AS item_count
    FROM 
        wishlist w
    LEFT JOIN wishlist_items wi 
        ON w.wishlist_id = wi.wishlist_item_wishlist_id
    GROUP BY 
        w.wishlist_id
) AS wishlist_summary;"
Show me the total number of orders per user.,"SELECT 
    u.user_id,
    u.user_name,
    COUNT(o.order_id) AS total_orders
FROM 
    users u
LEFT JOIN orders o 
    ON u.user_id = o.order_user_id
GROUP BY 
    u.user_id, u.user_name
ORDER BY 
    total_orders DESC;"
Can you show total sales value per product?,"SELECT 
    p.product_id,
    p.product_name,
    COALESCE(SUM(oi.order_item_quantity * oi.order_item_price), 0) AS total_sales
FROM 
    products p
LEFT JOIN order_items oi 
    ON p.product_id = oi.order_item_product_id
LEFT JOIN orders o 
    ON oi.order_item_order_id = o.order_id
WHERE 
    o.order_status IN ('completed', 'shipped', 'delivered')
GROUP BY 
    p.product_id, p.product_name
ORDER BY 
    total_sales DESC;"
Which orders are still pending?,"SELECT 
    o.order_id,
    u.user_name,
    o.order_total,
    o.order_status,
    o.order_created_at
FROM 
    orders o
JOIN users u 
    ON o.order_user_id = u.user_id
WHERE 
    LOWER(o.order_status) = 'pending'
ORDER BY 
    o.order_created_at DESC;"
Show me the overall revenue from all completed orders.,"SELECT 
    ROUND(COALESCE(SUM(oi.order_item_quantity * oi.order_item_price), 0), 2) AS total_revenue
FROM 
    orders o
JOIN order_items oi 
    ON o.order_id = oi.order_item_order_id
WHERE 
    LOWER(o.order_status) IN ('completed', 'shipped', 'delivered');"
List every order placed during the past 7 days.,"SELECT 
    o.order_id,
    o.order_user_id,
    o.order_total,
    o.order_status,
    o.order_created_at
FROM 
    orders o
WHERE 
    o.order_created_at >= NOW() - INTERVAL '7 days'
ORDER BY 
    o.order_created_at DESC;"
What is the average order total?,"SELECT 
    ROUND(AVG(o.order_total), 2) AS average_order_total
FROM 
    orders o
WHERE 
    LOWER(o.order_status) IN ('completed', 'shipped', 'delivered');"
Which users spent more than $500 in total?,"SELECT 
    u.user_id,
    u.user_name,
    SUM(o.order_total) AS total_spent
FROM 
    users u
JOIN orders o 
    ON u.user_id = o.order_user_id
WHERE 
    LOWER(o.order_status) IN ('completed', 'shipped', 'delivered')
GROUP BY 
    u.user_id, u.user_name
HAVING 
    SUM(o.order_total) > 500
ORDER BY 
    total_spent DESC;"
What is the total quantity sold for each product?,"SELECT 
    p.product_id,
    p.product_name,
    COALESCE(SUM(oi.order_item_quantity), 0) AS total_quantity_sold
FROM 
    products p
LEFT JOIN order_items oi 
    ON p.product_id = oi.order_item_product_id
LEFT JOIN orders o 
    ON oi.order_item_order_id = o.order_id
WHERE 
    LOWER(o.order_status) IN ('completed', 'shipped', 'delivered')  -- only successful sales
GROUP BY 
    p.product_id, p.product_name
ORDER BY 
    total_quantity_sold DESC;"
What’s the order with the highest purchase value?,"SELECT 
    o.order_id,
    o.order_user_id,
    o.order_total,
    o.order_status,
    o.order_created_at
FROM 
    orders o
WHERE 
    o.order_total = (
        SELECT MAX(order_total) FROM orders
        WHERE LOWER(order_status) IN ('completed', 'shipped', 'delivered')
    );
"
What pairs of products are most frequently ordered together?,"SELECT 
    p1.product_name AS product_a,
    p2.product_name AS product_b,
    COUNT(*) AS times_purchased_together
FROM 
    order_items oi1
JOIN order_items oi2 
    ON oi1.order_item_order_id = oi2.order_item_order_id
    AND oi1.order_item_product_id < oi2.order_item_product_id 
JOIN products p1 
    ON oi1.order_item_product_id = p1.product_id
JOIN products p2 
    ON oi2.order_item_product_id = p2.product_id
JOIN orders o 
    ON oi1.order_item_order_id = o.order_id
WHERE 
    LOWER(o.order_status) IN ('completed', 'shipped', 'delivered')
GROUP BY 
    p1.product_name, p2.product_name
ORDER BY 
    times_purchased_together DESC
LIMIT 10;"
Which orders were paid successfully?,"SELECT 
    o.order_id,
    o.order_user_id,
    o.order_total,
    o.order_status,
    p.payment_status,
    p.payment_date
FROM 
    orders o
JOIN payments p 
    ON o.order_id = p.payment_order_id
WHERE 
    LOWER(p.payment_status) = 'successful'
ORDER BY 
    p.payment_date DESC;"
What payment methods are most used?,"SELECT 
    p.payment_method,
    COUNT(t.transaction_id) AS times_used
FROM 
    payments p
JOIN transactions t 
    ON p.payment_id = t.transaction_payment_id
GROUP BY 
    p.payment_method
ORDER BY 
    times_used DESC;
"
List the orders that used discount coupons.,"SELECT 
    o.order_id,
    o.order_user_id,
    o.order_total,
    c.coupon_code,
    c.coupon_description,
    c.coupon_discount_percentage,
    o.order_created_at
FROM 
    orders o
JOIN order_coupons oc 
    ON o.order_id = oc.order_coupon_order_id
JOIN coupons c 
    ON oc.order_coupon_coupon_id = c.coupon_id
ORDER BY 
    o.order_created_at DESC;"
What is the average discount percentage of all coupons?,"SELECT 
    ROUND(AVG(coupon_discount_percentage), 2) AS average_discount_percentage
FROM 
    coupons;"
How many transactions failed last month?,"SELECT 
    COUNT(*) AS failed_transactions_last_month
FROM 
    transactions
WHERE 
    LOWER(transaction_status) = 'failed'
    AND DATE_TRUNC('month', transaction_created_at) = DATE_TRUNC('month', CURRENT_DATE - INTERVAL '1 month');
"
Which coupons expired recently?,"SELECT 
    coupon_id,
    coupon_code,
    coupon_description,
    coupon_discount_percentage,
    coupon_end_date
FROM 
    coupons
WHERE 
    coupon_end_date < NOW()
ORDER BY 
    coupon_end_date DESC;
"
What is the total discount amount given through coupons?,"SELECT 
    ROUND(SUM(o.order_total * (c.coupon_discount_percentage / 100.0)), 2) AS total_discount_amount
FROM 
    orders o
JOIN order_coupons oc 
    ON o.order_id = oc.order_coupon_order_id
JOIN coupons c 
    ON oc.order_coupon_coupon_id = c.coupon_id;
"
How many payments are still pending?,"SELECT 
    COUNT(*) AS pending_payments
FROM 
    payments
WHERE 
    LOWER(payment_status) = 'pending';"
Which discount codes were applied to more than one order?,"SELECT 
    c.coupon_id,
    c.coupon_code,
    c.coupon_description,
    COUNT(DISTINCT oc.order_coupon_order_id) AS times_used
FROM 
    coupons c
JOIN order_coupons oc 
    ON c.coupon_id = oc.order_coupon_coupon_id
GROUP BY 
    c.coupon_id, c.coupon_code, c.coupon_description
HAVING 
    COUNT(DISTINCT oc.order_coupon_order_id) > 1
ORDER BY 
    times_used DESC;
"
Which orders have already been shipped?,"SELECT 
    o.order_id,
    o.order_user_id,
    o.order_total,
    o.order_status,
    o.order_created_at,
    o.order_shipped_at
FROM 
    orders o
WHERE 
    LOWER(o.order_status) = 'shipped'
ORDER BY 
    o.order_shipped_at DESC;"
What is the status of each shipment?,"SELECT 
    s.shipment_id,
    o.order_id,
    o.order_user_id,
    s.shipment_status,
    s.shipment_created_at,
    s.shipment_updated_at
FROM 
    shipments s
JOIN orders o 
    ON s.shipment_order_id = o.order_id
ORDER BY 
    s.shipment_created_at DESC;"
Which users have returned products?,"SELECT 
    DISTINCT u.user_id,
    u.user_name,
    u.user_email
FROM 
    users u
JOIN returns r 
    ON u.user_id = r.return_user_id
ORDER BY 
    u.user_name;"
What are the most common reasons for returns?,"SELECT 
    r.return_reason,
    COUNT(*) AS times_reported
FROM 
    returns r
GROUP BY 
    r.return_reason
ORDER BY 
    times_reported DESC;
"
How many returns were created this month?,"SELECT 
    COUNT(*) AS returns_created_this_month
FROM 
    returns
WHERE 
    DATE_TRUNC('month', return_created_at) = DATE_TRUNC('month', CURRENT_DATE);"
What percentage of orders were returned?,"SELECT 
    ROUND(
        (COUNT(DISTINCT r.return_order_id)::DECIMAL / COUNT(DISTINCT o.order_id)) * 100, 
        2
    ) AS return_percentage
FROM 
    orders o
LEFT JOIN returns r 
    ON o.order_id = r.return_order_id;"
Show me the average processing time from order to shipment,"SELECT 
    ROUND(
        AVG(EXTRACT(EPOCH FROM (s.shipment_created_at - o.order_created_at)) / 3600), 
        2
    ) AS avg_hours_between_order_and_shipment
FROM 
    orders o
JOIN shipments s 
    ON o.order_id = s.shipment_order_id
WHERE 
    s.shipment_created_at IS NOT NULL
    AND o.order_created_at IS NOT NULL;"
,
List each product along with its category and vendor name.,"SELECT 
    p.product_id,
    p.product_name,
    c.category_name,
    v.vendor_name
FROM products AS p
JOIN category_products AS cp
    ON p.product_id = cp.category_product_product_id
JOIN categories AS c
    ON cp.category_product_category_id = c.category_id
JOIN product_vendors AS pv
    ON p.product_id = pv.product_vendor_product_id
JOIN vendors AS v
    ON pv.product_vendor_vendor_id = v.vendor_id
ORDER BY p.product_id;"
Which vendors supply products priced above the average product price?,"SELECT DISTINCT
    v.vendor_id,
    v.vendor_name,
    v.vendor_email
FROM vendors AS v
JOIN product_vendors AS pv
    ON v.vendor_id = pv.product_vendor_vendor_id
JOIN products AS p
    ON pv.product_vendor_product_id = p.product_id
WHERE p.product_price > (
    SELECT AVG(product_price)
    FROM products
)
ORDER BY v.vendor_name;"
“Show me categories that have products from multiple vendors.,"SELECT 
    c.category_id,
    c.category_name
FROM categories AS c
JOIN category_products AS cp
    ON c.category_id = cp.category_product_category_id
JOIN products AS p
    ON cp.category_product_product_id = p.product_id
JOIN product_vendors AS pv
    ON p.product_id = pv.product_vendor_product_id
GROUP BY c.category_id, c.category_name
HAVING COUNT(DISTINCT pv.product_vendor_vendor_id) > 1
ORDER BY c.category_name;"
Show the total number of products and average price per category.,"SELECT 
    c.category_id,
    c.category_name,
    COUNT(p.product_id) AS total_products,
    ROUND(AVG(p.product_price), 2) AS average_price
FROM categories AS c
JOIN category_products AS cp
    ON c.category_id = cp.category_product_category_id
JOIN products AS p
    ON cp.category_product_product_id = p.product_id
GROUP BY c.category_id, c.category_name
ORDER BY c.category_name;"
Show products that haven’t been tagged.,"SELECT 
    p.product_id,
    p.product_name
FROM products AS p
LEFT JOIN product_tags AS pt
    ON p.product_id = pt.product_tag_product_id
WHERE pt.product_tag_tag_id IS NULL
ORDER BY p.product_name;"
List vendors that supply more than five products.,"SELECT 
    v.vendor_id,
    v.vendor_name,
    COUNT(DISTINCT pv.product_vendor_product_id) AS total_products
FROM vendors AS v
JOIN product_vendors AS pv
    ON v.vendor_id = pv.product_vendor_vendor_id
GROUP BY v.vendor_id, v.vendor_name
HAVING COUNT(DISTINCT pv.product_vendor_product_id) > 5
ORDER BY total_products DESC;"
List all products that appear in several categories.,"SELECT 
    p.product_id,
    p.product_name,
    COUNT(DISTINCT cp.category_product_category_id) AS category_count
FROM products AS p
JOIN category_products AS cp
    ON p.product_id = cp.category_product_product_id
GROUP BY p.product_id, p.product_name
HAVING COUNT(DISTINCT cp.category_product_category_id) > 1
ORDER BY category_count DESC, p.product_name;"
Which products have more than three tags assigned?,"SELECT 
    p.product_id,
    p.product_name,
    COUNT(DISTINCT pt.product_tag_tag_id) AS tag_count
FROM products AS p
JOIN product_tags AS pt
    ON p.product_id = pt.product_tag_product_id
GROUP BY p.product_id, p.product_name
HAVING COUNT(DISTINCT pt.product_tag_tag_id) > 3
ORDER BY tag_count DESC, p.product_name;"
What is the most expensive product in each category?,"SELECT 
    c.category_id,
    c.category_name,
    p.product_id,
    p.product_name,
    p.product_price
FROM categories AS c
JOIN category_products AS cp
    ON c.category_id = cp.category_product_category_id
JOIN products AS p
    ON cp.category_product_product_id = p.product_id
WHERE p.product_price = (
    SELECT MAX(p2.product_price)
    FROM category_products AS cp2
    JOIN products AS p2
        ON cp2.category_product_product_id = p2.product_id
    WHERE cp2.category_product_category_id = c.category_id
)
ORDER BY c.category_name;"
Show the number of new products added per month in the current year.,"SELECT 
    DATE_TRUNC('month', product_created_at) AS month,
    COUNT(*) AS total_products
FROM products
WHERE EXTRACT(YEAR FROM product_created_at) = EXTRACT(YEAR FROM CURRENT_DATE)
GROUP BY DATE_TRUNC('month', product_created_at)
ORDER BY month;"
Which discounts are active right now?,"SELECT 
    discount_id,
    discount_name,
    discount_percentage,
    discount_start_date,
    discount_end_date
FROM discounts
WHERE CURRENT_DATE BETWEEN discount_start_date AND discount_end_date
ORDER BY discount_end_date;"
Find which discounts cover the most products,"SELECT 
    d.discount_id,
    d.discount_name,
    COUNT(DISTINCT pd.product_discount_product_id) AS total_products
FROM discounts AS d
JOIN product_discounts AS pd
    ON d.discount_id = pd.product_discount_discount_id
GROUP BY d.discount_id, d.discount_name
ORDER BY total_products DESC, d.discount_name;"
Show products that are associated with both a discount and a coupon.,"SELECT DISTINCT
    p.product_id,
    p.product_name
FROM products AS p
LEFT JOIN product_discounts AS pd
    ON p.product_id = pd.product_discount_product_id
LEFT JOIN order_items AS oi
    ON p.product_id = oi.order_item_product_id
LEFT JOIN order_coupons AS oc
    ON oi.order_item_order_id = oc.order_coupon_order_id
WHERE pd.product_discount_discount_id IS NOT NULL
  AND oc.order_coupon_coupon_id IS NOT NULL
ORDER BY p.product_name;
"
Which coupons give more than 20% off and are currently active?,"SELECT 
    coupon_id,
    coupon_code,
    coupon_description,
    coupon_discount_percentage,
    coupon_start_date,
    coupon_end_date
FROM coupons
WHERE coupon_discount_percentage > 20
  AND CURRENT_DATE BETWEEN coupon_start_date AND coupon_end_date
ORDER BY coupon_discount_percentage DESC;"
Find the average discount percentage per product.,"SELECT 
    p.product_id,
    p.product_name,
    ROUND(AVG(d.discount_percentage), 2) AS average_discount_percentage
FROM products AS p
JOIN product_discounts AS pd
    ON p.product_id = pd.product_discount_product_id
JOIN discounts AS d
    ON pd.product_discount_discount_id = d.discount_id
GROUP BY p.product_id, p.product_name
ORDER BY average_discount_percentage DESC;"
Identify coupons that overlap in active date ranges.,"SELECT 
    c1.coupon_id AS coupon_id_1,
    c1.coupon_code AS coupon_code_1,
    c2.coupon_id AS coupon_id_2,
    c2.coupon_code AS coupon_code_2,
    c1.coupon_start_date AS coupon_1_start,
    c1.coupon_end_date AS coupon_1_end,
    c2.coupon_start_date AS coupon_2_start,
    c2.coupon_end_date AS coupon_2_end
FROM coupons AS c1
JOIN coupons AS c2
    ON c1.coupon_id < c2.coupon_id
   AND c1.coupon_start_date <= c2.coupon_end_date
   AND c2.coupon_start_date <= c1.coupon_end_date
ORDER BY c1.coupon_id, c2.coupon_id;"
Find all discounts that expired within the last 30 days.,"SELECT 
    discount_id,
    discount_name,
    discount_percentage,
    discount_start_date,
    discount_end_date
FROM discounts
WHERE discount_end_date BETWEEN (CURRENT_DATE - INTERVAL '30 days') AND CURRENT_DATE
ORDER BY discount_end_date DESC;"
List all products that have multiple discounts assigned.,"SELECT 
    p.product_id,
    p.product_name,
    COUNT(DISTINCT pd.product_discount_discount_id) AS discount_count
FROM products AS p
JOIN product_discounts AS pd
    ON p.product_id = pd.product_discount_product_id
GROUP BY p.product_id, p.product_name
HAVING COUNT(DISTINCT pd.product_discount_discount_id) > 1
ORDER BY discount_count DESC, p.product_name;"
Show which coupons were used by multiple users through their orders.,"SELECT 
    c.coupon_id,
    c.coupon_code,
    COUNT(DISTINCT o.order_user_id) AS user_count
FROM coupons AS c
JOIN order_coupons AS oc
    ON c.coupon_id = oc.order_coupon_coupon_id
JOIN orders AS o
    ON oc.order_coupon_order_id = o.order_id
GROUP BY c.coupon_id, c.coupon_code
HAVING COUNT(DISTINCT o.order_user_id) > 1
ORDER BY user_count DESC, c.coupon_code;"
Find the total number of coupons used per month.,"SELECT 
    DATE_TRUNC('month', o.order_date) AS month,
    COUNT(DISTINCT oc.order_coupon_coupon_id) AS total_coupons_used
FROM orders AS o
JOIN order_coupons AS oc
    ON o.order_id = oc.order_coupon_order_id
GROUP BY DATE_TRUNC('month', o.order_date)
ORDER BY month;"
Find all users who have placed more than 3 orders.,"SELECT 
    u.user_id,
    u.user_name,
    COUNT(o.order_id) AS total_orders
FROM users AS u
JOIN orders AS o
    ON u.user_id = o.order_user_id
GROUP BY u.user_id, u.user_name
HAVING COUNT(o.order_id) > 3
ORDER BY total_orders DESC;"
"For each user, show the total number of products they have purchased.","SELECT 
    u.user_id,
    u.user_name,
    SUM(oi.order_item_quantity) AS total_products_purchased
FROM users AS u
JOIN orders AS o
    ON u.user_id = o.order_user_id
JOIN order_items AS oi
    ON o.order_id = oi.order_item_order_id
GROUP BY u.user_id, u.user_name
ORDER BY total_products_purchased DESC;"
Find orders that include products from more than one vendor.,"SELECT 
    o.order_id,
    COUNT(DISTINCT p.product_vendor_id) AS vendor_count
FROM orders AS o
JOIN order_items AS oi
    ON o.order_id = oi.order_item_order_id
JOIN products AS p
    ON oi.order_item_product_id = p.product_id
GROUP BY o.order_id
HAVING COUNT(DISTINCT p.product_vendor_id) > 1
ORDER BY vendor_count DESC, o.order_id;"
How much did each user spend per month?,"SELECT 
    u.user_id,
    u.user_name,
    DATE_TRUNC('month', o.order_created_at) AS month,
    SUM(o.order_total) AS total_spent
FROM users AS u
JOIN orders AS o
    ON u.user_id = o.order_user_id
JOIN transactions AS t
    ON o.order_id = t.transaction_order_id
JOIN payments AS p
    ON t.transaction_payment_id = p.payment_id
WHERE 
    o.order_status = 'success' 
    AND t.transaction_status = 'success'
    AND p.payment_status = 'paid'
GROUP BY u.user_id, u.user_name, DATE_TRUNC('month', o.order_created_at)
ORDER BY u.user_id, month;
"
Which products appear in more than 10 different orders?,"SELECT 
    p.product_id,
    p.product_name,
    COUNT(DISTINCT oi.order_item_order_id) AS order_count
FROM products AS p
JOIN order_items AS oi
    ON p.product_id = oi.order_item_product_id
GROUP BY p.product_id, p.product_name
HAVING COUNT(DISTINCT oi.order_item_order_id) > 10
ORDER BY order_count DESC, p.product_name;"
Find all orders where someone applied a coupon and later returned items.,"SELECT DISTINCT
    o.order_id,
    o.order_total,
    o.order_status,
    o.order_created_at
FROM orders AS o
JOIN order_coupons AS oc
    ON o.order_id = oc.order_coupon_order_id
JOIN returns AS r
    ON o.order_id = r.return_order_id
ORDER BY o.order_created_at DESC;
"
How much revenue was generated by each product category?,"SELECT 
    c.category_id,
    c.category_name,
    SUM(oi.order_item_quantity * oi.order_item_price) AS total_revenue
FROM categories AS c
JOIN product_categories AS pc
    ON c.category_id = pc.category_id
JOIN products AS p
    ON pc.product_id = p.product_id
JOIN order_items AS oi
    ON p.product_id = oi.order_item_product_id
JOIN orders AS o
    ON oi.order_item_order_id = o.order_id
JOIN transactions AS t
    ON o.order_id = t.transaction_order_id
JOIN payments AS pmt
    ON t.transaction_payment_id = pmt.payment_id
WHERE 
    o.order_status = 'success'
    AND t.transaction_status = 'success'
    AND pmt.payment_status = 'paid'
GROUP BY c.category_id, c.category_name
ORDER BY total_revenue DESC;"
Find users who made purchases in consecutive months.,"WITH user_months AS (
    SELECT DISTINCT
        u.user_id,
        u.user_name,
        DATE_TRUNC('month', o.order_created_at) AS month
    FROM users u
    JOIN orders o ON u.user_id = o.order_user_id
    JOIN transactions t ON o.order_id = t.transaction_order_id
    JOIN payments pmt ON t.transaction_payment_id = pmt.payment_id
    WHERE 
        o.order_status = 'success'
        AND t.transaction_status = 'success'
        AND pmt.payment_status = 'paid'
),
ranked AS (
    SELECT
        user_id,
        user_name,
        month,
        ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY month) AS rn
    FROM user_months
),
grouped AS (
    SELECT
        user_id,
        user_name,
        month,
        (month - (rn || ' month')::interval) AS grp
    FROM ranked
)
SELECT DISTINCT
    user_id,
    user_name
FROM grouped
GROUP BY user_id, user_name, grp
HAVING COUNT(*) > 1
ORDER BY user_name;
"
Show the top 5 products with the highest total sales revenue.,"SELECT 
    p.product_id,
    p.product_name,
    SUM(oi.order_item_quantity * oi.order_item_price) AS total_revenue
FROM products AS p
JOIN order_items AS oi
    ON p.product_id = oi.order_item_product_id
JOIN orders AS o
    ON oi.order_item_order_id = o.order_id
JOIN transactions AS t
    ON o.order_id = t.transaction_order_id
JOIN payments AS pmt
    ON t.transaction_payment_id = pmt.payment_id
WHERE 
    o.order_status = 'success'
    AND t.transaction_status = 'success'
    AND pmt.payment_status = 'paid'
GROUP BY p.product_id, p.product_name
ORDER BY total_revenue DESC
LIMIT 5;"
"For each order, show total quantity and total price of items.","SELECT 
    o.order_id,
    SUM(oi.order_item_quantity) AS total_quantity,
    SUM(oi.order_item_quantity * oi.order_item_price) AS total_price
FROM orders AS o
JOIN order_items AS oi 
    ON o.order_id = oi.order_item_order_id
JOIN transactions AS t 
    ON o.order_id = t.transaction_order_id
JOIN payments AS pmt
    ON t.transaction_payment_id = pmt.payment_id
GROUP BY o.order_id
ORDER BY o.order_id;
"
"Find the total amount of payments by status (e.g., successful, pending).","SELECT 
    payment_status,
    SUM(payment_amount) AS total_amount
FROM payments
GROUP BY payment_status
ORDER BY total_amount DESC;"
Which orders have multiple transactions linked?,"SELECT 
    p.order_id,
    COUNT(*) AS transaction_count
FROM payments p
GROUP BY p.order_id
HAVING COUNT(*) > 1;"
List all failed transactions along with the corresponding user email.,"SELECT 
    p.payment_id,
    p.order_id,
    p.amount,
    p.payment_status,
    u.email AS user_email
FROM payments p
JOIN orders o ON p.order_id = o.order_id
JOIN users u ON o.user_id = u.user_id
WHERE p.payment_status = 'failed';"
Find the total payment amount processed by each payment method.,"SELECT 
    payment_method,
    SUM(amount) AS total_amount_processed
FROM payments
GROUP BY payment_method
ORDER BY total_amount_processed DESC;
"
Identify orders where payment and transaction statuses don’t match.,"SELECT 
    o.order_id,
    p.payment_id,
    p.payment_status,
    t.transaction_id,
    t.transaction_status
FROM orders o
JOIN payments p ON o.order_id = p.order_id
JOIN transactions t ON o.order_id = t.order_id
WHERE p.payment_status <> t.transaction_status;"
Which payment methods are most successful (based on completed status)?,"SELECT 
    p.payment_method,
    COUNT(*) AS successful_payments
FROM payments p
WHERE p.payment_status = 'paid'
GROUP BY p.payment_method
ORDER BY successful_payments DESC;
"
Find the average time delay between order creation and payment completion.,"SELECT 
    AVG(p.payment_completed_at - o.order_created_at) AS avg_delay
FROM orders o
JOIN payments p ON o.order_id = p.order_id
WHERE p.payment_status = 'completed';"
Show all transactions related to orders that used a coupon.,"SELECT 
    t.transaction_id,
    t.order_id,
    t.transaction_amount,
    t.transaction_status,
    t.transaction_created_at,
    c.coupon_code
FROM transactions t
JOIN orders o ON t.order_id = o.order_id
JOIN coupons c ON o.coupon_id = c.coupon_id;"
Identify users whose payments have failed more than once.,"SELECT 
    u.user_id,
    u.user_name,
    u.user_email,
    COUNT(p.payment_id) AS failed_payment_count
FROM users u
JOIN orders o ON u.user_id = o.user_id
JOIN payments p ON o.order_id = p.order_id
WHERE p.payment_status = 'failed'
GROUP BY u.user_id, u.user_name, u.user_email
HAVING COUNT(p.payment_id) > 1;"
Find total transaction counts per month for the past year.,"SELECT 
    DATE_TRUNC('month', t.transaction_created_at) AS month,
    COUNT(*) AS total_transactions
FROM transactions t
WHERE t.transaction_created_at >= (CURRENT_DATE - INTERVAL '1 year')
GROUP BY month
ORDER BY month;"
List all orders that have a shipment but no return.,"SELECT 
    o.order_id,
    o.user_id,
    o.order_created_at,
    s.shipment_id,
    s.shipment_status
FROM orders o
JOIN shipments s ON o.order_id = s.order_id
LEFT JOIN returns r ON o.order_id = r.order_id
WHERE r.return_id IS NULL;"
Find all returns created within 7 days after shipment.,"SELECT 
    r.return_id,
    r.return_order_id,
    r.return_user_id,
    r.return_created_at,
    s.shipment_id,
    s.shipment_created_at,
    (r.return_created_at - s.shipment_created_at) AS delay_interval
FROM returns r
JOIN shipments s ON r.return_order_id = s.shipment_order_id
WHERE 
    r.return_created_at >= s.shipment_created_at
    AND r.return_created_at <= s.shipment_created_at + INTERVAL '7 days'
ORDER BY r.return_created_at;
"
Calculate the percentage of returned orders by month.,"SELECT 
    TO_CHAR(o.order_created_at, 'YYYY-MM') AS month,
    COUNT(DISTINCT o.order_id) AS total_orders,
    COUNT(DISTINCT r.return_id) AS returned_orders,
    ROUND(
        COUNT(DISTINCT r.return_id)::decimal / COUNT(DISTINCT o.order_id) * 100, 
        2
    ) AS return_rate_percent
FROM orders o
LEFT JOIN returns r ON o.order_id = r.return_order_id
GROUP BY TO_CHAR(o.order_created_at, 'YYYY-MM')
ORDER BY month;"
Identify users who have returned more than two different products.,"SELECT 
    u.user_id,
    u.user_name,
    COUNT(DISTINCT r.return_order_id) AS different_products_returned
FROM users u
JOIN returns r ON u.user_id = r.return_user_id
GROUP BY u.user_id, u.user_name
HAVING COUNT(DISTINCT r.return_order_id) > 2
ORDER BY different_products_returned DESC;"
Show the average number of days between order creation and shipment creation.,"SELECT 
    ROUND(AVG(EXTRACT(DAY FROM (s.shipment_created_at - o.order_created_at))), 2) 
        AS avg_days_between_order_and_shipment
FROM orders o
JOIN shipments s ON o.order_id = s.shipment_order_id;"
Find users who have both active shipments and pending returns.,"SELECT DISTINCT
    u.user_id,
    u.user_name,
    u.user_email
FROM users u
JOIN orders o ON u.user_id = o.order_user_id
JOIN shipments s ON o.order_id = s.shipment_order_id
JOIN returns r ON o.order_id = r.return_order_id
WHERE 
    s.shipment_status = 'active'
    AND r.return_status = 'pending';"
"For each city, show how many shipments have been delivered.","SELECT 
    a.address_city,
    COUNT(s.shipment_id) AS delivered_shipments
FROM shipments s
JOIN addresses a 
    ON s.shipment_address_id = a.address_id
WHERE s.shipment_status = 'delivered'
GROUP BY a.address_city
ORDER BY delivered_shipments DESC;"
Identify the top 5 cities with the highest number of returns.,"SELECT 
    a.address_city,
    COUNT(r.return_id) AS total_returns
FROM returns r
JOIN shipments s 
    ON r.return_order_id = s.shipment_order_id
JOIN addresses a 
    ON s.shipment_address_id = a.address_id
GROUP BY a.address_city
ORDER BY total_returns DESC
LIMIT 5;"
Find all orders where shipment and payment were created on the same day.,"SELECT 
    o.order_id,
    o.order_user_id,
    p.payment_created_at::date AS payment_date,
    s.shipment_created_at::date AS shipment_date
FROM orders o
JOIN payments p 
    ON o.order_id = p.payment_order_id
JOIN shipments s 
    ON o.order_id = s.shipment_order_id
WHERE p.payment_created_at::date = s.shipment_created_at::date;"
Find the top 3 vendors whose products generate the highest total order revenue.,"SELECT 
    v.vendor_id,
    v.vendor_name,
    SUM(oi.order_item_quantity * oi.order_item_price) AS total_revenue
FROM vendors v
JOIN product_vendors pv 
    ON v.vendor_id = pv.product_vendor_vendor_id
JOIN products p 
    ON pv.product_vendor_product_id = p.product_id
JOIN order_items oi 
    ON oi.order_item_product_id = p.product_id
GROUP BY v.vendor_id, v.vendor_name
ORDER BY total_revenue DESC
LIMIT 3;"
"For each product, calculate its total sales, average discount applied, and total number of reviews.","SELECT 
    p.product_id,
    p.product_name,
    SUM(oi.order_item_quantity * oi.order_item_price) AS total_sales,
    AVG(d.discount_percentage) AS avg_discount_applied,
    COUNT(DISTINCT r.review_id) AS total_reviews
FROM products p
LEFT JOIN order_items oi 
    ON oi.order_item_product_id = p.product_id
LEFT JOIN product_discounts pd 
    ON pd.product_discount_product_id = p.product_id
LEFT JOIN discounts d 
    ON d.discount_id = pd.product_discount_discount_id
LEFT JOIN reviews r 
    ON r.review_product_id = p.product_id
GROUP BY p.product_id, p.product_name
ORDER BY total_sales DESC;"
"Identify products that have never been added to any cart, wishlist, or order.","SELECT 
    p.product_id,
    p.product_name
FROM products p
LEFT JOIN cart_items ci 
    ON ci.cart_item_product_id = p.product_id
LEFT JOIN wishlist_items wi 
    ON wi.wishlist_item_product_id = p.product_id
LEFT JOIN order_items oi 
    ON oi.order_item_product_id = p.product_id
WHERE ci.cart_item_id IS NULL
  AND wi.wishlist_item_id IS NULL
  AND oi.order_item_id IS NULL;
"
"For each category, list the most popular product (based on total quantity sold).","WITH product_sales AS (
    SELECT 
        cp.category_product_category_id AS category_id,
        c.category_name,
        p.product_id,
        p.product_name,
        SUM(oi.order_item_quantity) AS total_quantity_sold
    FROM category_products cp
    JOIN categories c 
        ON c.category_id = cp.category_product_category_id
    JOIN products p 
        ON p.product_id = cp.category_product_product_id
    JOIN order_items oi 
        ON oi.order_item_product_id = p.product_id
    GROUP BY cp.category_product_category_id, c.category_name, p.product_id, p.product_name
),
ranked AS (
    SELECT 
        *,
        RANK() OVER (PARTITION BY category_id ORDER BY total_quantity_sold DESC) AS rnk
    FROM product_sales
)
SELECT 
    category_id,
    category_name,
    product_id,
    product_name,
    total_quantity_sold
FROM ranked
WHERE rnk = 1;"
Show vendors whose average product rating is higher than the overall store average.,"WITH product_avg AS (
    SELECT 
        p.product_vendor_id AS vendor_id,
        AVG(r.review_rating) AS avg_rating
    FROM products p
    JOIN reviews r 
        ON r.review_product_id = p.product_id
    GROUP BY p.product_vendor_id
),
store_avg AS (
    SELECT 
        AVG(r.review_rating) AS overall_avg_rating
    FROM reviews r
)
SELECT 
    v.vendor_id,
    v.vendor_name,
    pa.avg_rating
FROM product_avg pa
JOIN vendors v 
    ON v.vendor_id = pa.vendor_id,
     store_avg sa
WHERE pa.avg_rating > sa.overall_avg_rating
ORDER BY pa.avg_rating DESC;"
Identify categories with no active products (where all related products are discontinued or not in any order).,"SELECT 
    c.category_id,
    c.category_name
FROM categories c
LEFT JOIN category_products cp 
    ON cp.category_product_category_id = c.category_id
LEFT JOIN products p 
    ON p.product_id = cp.category_product_product_id
LEFT JOIN order_items oi 
    ON oi.order_item_product_id = p.product_id
GROUP BY c.category_id, c.category_name
HAVING COUNT(oi.order_item_id) = 0;"
"For each vendor, calculate total revenue, average product price, and total units sold.","SELECT 
    v.vendor_id,
    v.vendor_name,
    SUM(oi.order_item_quantity * oi.order_item_price) AS total_revenue,
    AVG(p.product_price) AS avg_product_price,
    SUM(oi.order_item_quantity) AS total_units_sold
FROM vendors v
JOIN product_vendors pv 
    ON pv.product_vendor_vendor_id = v.vendor_id
JOIN products p 
    ON p.product_id = pv.product_vendor_product_id
JOIN order_items oi 
    ON oi.order_item_product_id = p.product_id
GROUP BY v.vendor_id, v.vendor_name
ORDER BY total_revenue DESC;"
List products that appear in both a wishlist and an order for the same user.,"SELECT DISTINCT 
    p.product_id,
    p.product_name,
    w.wishlist_user_id AS user_id
FROM products p
JOIN wishlist_items wi 
    ON wi.wishlist_item_product_id = p.product_id
JOIN wishlists w 
    ON w.wishlist_id = wi.wishlist_item_wishlist_id
JOIN order_items oi 
    ON oi.order_item_product_id = p.product_id
JOIN orders o 
    ON o.order_id = oi.order_item_order_id
WHERE o.order_user_id = w.wishlist_user_id;"
Find the correlation between product price and average review rating (if stored numerically).,"SELECT 
    CORR(p.product_price, avg_r.avg_rating) AS price_rating_correlation
FROM products p
JOIN (
    SELECT 
        review_product_id AS product_id,
        AVG(review_rating) AS avg_rating
    FROM reviews
    GROUP BY review_product_id
) AS avg_r
ON avg_r.product_id = p.product_id;"
 ,"SELECT 
    d1.discount_id AS discount_1_id,
    d1.discount_name AS discount_1_name,
    d2.discount_id AS discount_2_id,
    d2.discount_name AS discount_2_name,
    p.product_id,
    p.product_name
FROM discounts d1
JOIN product_discounts pd1 
    ON pd1.product_discount_discount_id = d1.discount_id
JOIN discounts d2
    ON d1.discount_id < d2.discount_id 
JOIN product_discounts pd2 
    ON pd2.product_discount_discount_id = d2.discount_id
   AND pd1.product_discount_product_id = pd2.product_discount_product_id
JOIN products p 
    ON p.product_id = pd1.product_discount_product_id
WHERE d1.discount_start_date <= d2.discount_end_date
  AND d2.discount_start_date <= d1.discount_end_date;
"
Find the top 5 products that received the largest total discount amount from coupons and discounts combined.,"WITH product_discounts_total AS (
    SELECT 
        pd.product_discount_product_id AS product_id,
        SUM((d.discount_percentage / 100.0) * p.product_price) AS total_discount_amount
    FROM product_discounts pd
    JOIN discounts d 
        ON d.discount_id = pd.product_discount_discount_id
    JOIN products p 
        ON p.product_id = pd.product_discount_product_id
    GROUP BY pd.product_discount_product_id
),
product_coupons_total AS (
    SELECT 
        pc.product_coupon_product_id AS product_id,
        SUM((c.coupon_discount_percentage / 100.0) * p.product_price) AS total_coupon_amount
    FROM product_coupons pc
    JOIN coupons c 
        ON c.coupon_id = pc.product_coupon_coupon_id
    JOIN products p 
        ON p.product_id = pc.product_coupon_product_id
    GROUP BY pc.product_coupon_product_id
),
combined AS (
    SELECT 
        p.product_id,
        p.product_name,
        COALESCE(d.total_discount_amount, 0) + COALESCE(c.total_coupon_amount, 0) AS total_discount_value
    FROM products p
    LEFT JOIN product_discounts_total d 
        ON d.product_id = p.product_id
    LEFT JOIN product_coupons_total c 
        ON c.product_id = p.product_id
)
SELECT 
    product_id,
    product_name,
    total_discount_value
FROM combined
ORDER BY total_discount_value DESC
LIMIT 5;"
Calculate the total discount value given per month (discount% × sales value).,"SELECT 
    DATE_TRUNC('month', o.order_created_at) AS month,
    SUM((d.discount_percentage / 100.0) * (oi.order_item_quantity * oi.order_item_price)) AS total_discount_value
FROM orders o
JOIN order_items oi 
    ON oi.order_item_order_id = o.order_id
JOIN product_discounts pd 
    ON pd.product_discount_product_id = oi.order_item_product_id
JOIN discounts d 
    ON d.discount_id = pd.product_discount_discount_id
GROUP BY DATE_TRUNC('month', o.order_created_at)
ORDER BY month;
"
Find users who have redeemed coupons more than once in different orders.,"SELECT 
    u.user_id,
    u.user_name,
    u.user_email,
    COUNT(DISTINCT oc.order_coupon_order_id) AS coupon_orders_count
FROM users u
JOIN orders o 
    ON o.order_user_id = u.user_id
JOIN order_coupons oc 
    ON oc.order_coupon_order_id = o.order_id
GROUP BY u.user_id, u.user_name, u.user_email
HAVING COUNT(DISTINCT oc.order_coupon_order_id) > 1
ORDER BY coupon_orders_count DESC;"
Determine which discounts never got applied to any product.,"SELECT 
    d.discount_id,
    d.discount_name,
    d.discount_description,
    d.discount_percentage,
    d.discount_start_date,
    d.discount_end_date
FROM discounts d
LEFT JOIN product_discounts pd 
    ON d.discount_id = pd.product_discount_discount_id
WHERE pd.product_discount_id IS NULL;"
Find coupons that were active during the time of at least one order but were never used.,"SELECT 
    c.coupon_id,
    c.coupon_code,
    c.coupon_description,
    c.coupon_discount,
    c.coupon_start_date,
    c.coupon_end_date
FROM coupons c
WHERE EXISTS (
    SELECT 1
    FROM orders o
    WHERE o.order_created_at BETWEEN c.coupon_start_date AND c.coupon_end_date
)
AND NOT EXISTS (
    SELECT 1
    FROM orders o2
    WHERE o2.order_coupon_id = c.coupon_id
);"
"For each user, calculate how much total money they saved using coupons.","SELECT 
    u.user_id,
    u.user_name,
    u.user_email,
    SUM(
        (o.order_total_price * c.coupon_discount / 100.0)
    ) AS total_money_saved
FROM users u
JOIN orders o ON o.order_user_id = u.user_id
JOIN coupons c ON o.order_coupon_id = c.coupon_id
GROUP BY u.user_id, u.user_name, u.user_email
ORDER BY total_money_saved DESC;"
Compare the number of discounted vs non-discounted products sold each month.,"SELECT
    DATE_TRUNC('month', o.order_created_at) AS month,
    SUM(CASE WHEN d.discount_id IS NOT NULL THEN oi.quantity ELSE 0 END) AS discounted_products_sold,
    SUM(CASE WHEN d.discount_id IS NULL THEN oi.quantity ELSE 0 END) AS non_discounted_products_sold
FROM order_items oi
JOIN orders o ON oi.order_id = o.order_id
LEFT JOIN product_discounts pd ON oi.product_id = pd.product_id
LEFT JOIN discounts d ON pd.discount_id = d.discount_id
GROUP BY DATE_TRUNC('month', o.order_created_at)
ORDER BY month;"
"For each product, find the average discount percentage weighted by number of sales.","SELECT
    p.product_id,
    p.product_name,
    ROUND(
        SUM(d.discount_percentage * oi.quantity) / NULLIF(SUM(oi.quantity), 0),
        2
    ) AS weighted_avg_discount
FROM products p
JOIN order_items oi ON p.product_id = oi.product_id
JOIN product_discounts pd ON p.product_id = pd.product_id
JOIN discounts d ON pd.discount_id = d.discount_id
GROUP BY p.product_id, p.product_name
ORDER BY weighted_avg_discount DESC;"
Find the month-over-month growth rate in total sales for the last 12 months.,"WITH monthly_sales AS (
    SELECT
        DATE_TRUNC('month', o.order_created_at) AS month,
        SUM(o.order_total_price) AS total_sales
    FROM orders o
    WHERE o.order_created_at >= NOW() - INTERVAL '12 months'
    GROUP BY DATE_TRUNC('month', o.order_created_at)
)
SELECT
    TO_CHAR(ms.month, 'YYYY-MM') AS month,
    ms.total_sales,
    ROUND(
        (ms.total_sales - LAG(ms.total_sales) OVER (ORDER BY ms.month)) 
        / NULLIF(LAG(ms.total_sales) OVER (ORDER BY ms.month), 0) * 100,
        2
    ) AS mom_growth_rate
FROM monthly_sales ms
ORDER BY ms.month;"
"Identify the top 10 users by total spending, along with their most purchased product.","WITH user_spending AS (
    SELECT
        u.user_id,
        u.user_name,
        SUM(o.order_total_price) AS total_spent
    FROM users u
    JOIN orders o ON o.order_user_id = u.user_id
    GROUP BY u.user_id, u.user_name
),
user_top_product AS (
    SELECT
        o.order_user_id AS user_id,
        oi.product_id,
        p.product_name,
        SUM(oi.quantity) AS total_quantity,
        ROW_NUMBER() OVER (PARTITION BY o.order_user_id ORDER BY SUM(oi.quantity) DESC) AS rn
    FROM orders o
    JOIN order_items oi ON oi.order_id = o.order_id
    JOIN products p ON p.product_id = oi.product_id
    GROUP BY o.order_user_id, oi.product_id, p.product_name
)
SELECT
    us.user_id,
    us.user_name,
    us.total_spent,
    utp.product_name AS most_purchased_product,
    utp.total_quantity AS times_purchased
FROM user_spending us
JOIN user_top_product utp 
    ON us.user_id = utp.user_id AND utp.rn = 1
ORDER BY us.total_spent DESC
LIMIT 10;
"
Find all orders that contain products from more than three different vendors.,"SELECT
    o.order_id,
    COUNT(DISTINCT p.vendor_id) AS vendor_count
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
GROUP BY o.order_id
HAVING COUNT(DISTINCT p.vendor_id) > 3
ORDER BY vendor_count DESC;
"
Determine the most commonly co-purchased product pairs (frequently bought together).,"SELECT
    LEAST(oi1.product_id, oi2.product_id) AS product_id_1,
    GREATEST(oi1.product_id, oi2.product_id) AS product_id_2,
    COUNT(*) AS times_bought_together
FROM order_items oi1
JOIN order_items oi2 
    ON oi1.order_id = oi2.order_id 
   AND oi1.product_id < oi2.product_id
GROUP BY product_id_1, product_id_2
ORDER BY times_bought_together DESC
LIMIT 10;"
Find users who ordered at least one product from every category.,"SELECT 
    u.user_id,
    u.user_name,
    u.user_email
FROM users u
WHERE NOT EXISTS (
    SELECT 1
    FROM categories c
    WHERE NOT EXISTS (
        SELECT 1
        FROM orders o
        JOIN order_items oi ON o.order_id = oi.order_id
        JOIN products p ON oi.product_id = p.product_id
        JOIN product_categories pc ON p.product_id = pc.product_id
        WHERE o.order_user_id = u.user_id
          AND pc.category_id = c.category_id
    )
)
ORDER BY u.user_name;
"
"For each user, calculate the reorder rate (same product purchased multiple times).","WITH user_product_counts AS (
    SELECT
        o.order_user_id AS user_id,
        oi.product_id,
        COUNT(DISTINCT o.order_id) AS order_count
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    GROUP BY o.order_user_id, oi.product_id
),
user_reorder_stats AS (
    SELECT
        user_id,
        COUNT(*) FILTER (WHERE order_count > 1) AS repeated_products,
        COUNT(*) AS total_products
    FROM user_product_counts
    GROUP BY user_id
)
SELECT
    u.user_id,
    u.user_name,
    ROUND(
        (repeated_products::DECIMAL / NULLIF(total_products, 0)) * 100, 
        2
    ) AS reorder_rate_percent,
    repeated_products,
    total_products
FROM users u
JOIN user_reorder_stats urs ON u.user_id = urs.user_id
ORDER BY reorder_rate_percent DESC;
"
"Find orders that were partially fulfilled (some items shipped, others pending).","SELECT 
    o.order_id,
    o.order_created_at,
    COUNT(DISTINCT CASE WHEN s.shipment_status = 'shipped' THEN oi.order_item_id END) AS shipped_items,
    COUNT(DISTINCT CASE WHEN s.shipment_status != 'shipped' OR s.shipment_status IS NULL THEN oi.order_item_id END) AS pending_items
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
LEFT JOIN shipments s ON oi.order_item_id = s.order_item_id
GROUP BY o.order_id, o.order_created_at
HAVING 
    COUNT(DISTINCT CASE WHEN s.shipment_status = 'shipped' THEN oi.order_item_id END) > 0
    AND COUNT(DISTINCT CASE WHEN s.shipment_status != 'shipped' OR s.shipment_status IS NULL THEN oi.order_item_id END) > 0
ORDER BY o.order_created_at DESC;
"
Calculate the total failed transaction percentage per payment method.,"SELECT
    pm.payment_method_name,
    COUNT(t.transaction_id) FILTER (WHERE t.transaction_status = 'failed') AS failed_count,
    COUNT(t.transaction_id) AS total_count,
    ROUND(
        (COUNT(t.transaction_id) FILTER (WHERE t.transaction_status = 'failed')::DECIMAL 
        / NULLIF(COUNT(t.transaction_id), 0)) * 100,
        2
    ) AS failed_percentage
FROM transactions t
JOIN payments p ON t.payment_id = p.payment_id
JOIN payment_methods pm ON p.payment_method_id = pm.payment_method_id
GROUP BY pm.payment_method_name
ORDER BY failed_percentage DESC;"
Identify users who made payments using more than one payment method.,"SELECT 
    u.user_id,
    u.user_name,
    u.user_email,
    COUNT(DISTINCT p.payment_method) AS payment_method_count
FROM users u
JOIN orders o 
    ON u.user_id = o.order_user_id
JOIN payments p 
    ON o.order_id = p.payment_order_id
GROUP BY u.user_id, u.user_name, u.user_email
HAVING COUNT(DISTINCT p.payment_method) > 1
ORDER BY payment_method_count DESC;"
"Find the average number of transactions per order, grouped by month.","SELECT
    DATE_TRUNC('month', o.order_created_at) AS month,
    ROUND(AVG(t.transaction_count), 2) AS avg_transactions_per_order
FROM (
    SELECT 
        o.order_id,
        COUNT(t.transaction_id) AS transaction_count
    FROM orders o
    LEFT JOIN transactions t 
        ON o.order_id = t.transaction_order_id
    GROUP BY o.order_id
) AS t
JOIN orders o 
    ON o.order_id = t.order_id
GROUP BY DATE_TRUNC('month', o.order_created_at)
ORDER BY month;
"